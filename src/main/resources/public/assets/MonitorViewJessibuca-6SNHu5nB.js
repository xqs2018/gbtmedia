import{_ as O,r as b,a as I,j as G,n as H,l as K,b as u,e as r,m as P,v as F,F as g,p as _,o as d,t as f,q as C,h as J,s as Q,x as W,y as X}from"./index-BYlyECpH.js";import{c as Y,p as L}from"./gbt28181-C3wyvrue.js";import"./request-xFzgdMuq.js";const Z={class:"container"},x={class:"sidebar"},ee={class:"layout-switcher"},le=["value"],ae=["value"],te={class:"menu-scroll-container"},se=["onClick"],oe={class:"arrow"},ne={class:"second-level"},ce=["onClick"],re={class:"sequence-number"},ie=["data-layout"],ue=["onClick"],de={class:"video-box"},ve={key:0,class:"menu-label"},fe={key:1,class:"video-signal"},pe={__name:"MonitorViewJessibuca",setup(ye){const N=[{label:"1分屏",value:1},{label:"4分屏",value:4},{label:"6分屏",value:6},{label:"9分屏",value:9}],T=[{label:"关闭",value:0},{label:"1分钟",value:60},{label:"5分钟",value:300},{label:"10分钟",value:600},{label:"无限制",value:86400}],p=b(parseInt(window.localStorage.getItem("JessibucaIndexLayout"))||4),y=b(parseInt(window.localStorage.getItem("JessibucaPollInterval"))||0),S=b(0),V=b(null),h=I([]),i=I(Array.from({length:9},()=>({label:"",isPlaying:!1}))),w=I(Array.from({length:9},()=>null));let n=[];const o=b(-1);G(async()=>{let l=(await Y({})).data;l=l.map(s=>{let c=s.children.map(v=>({label:v.customName,key:s.gbId+"_"+v.gbId,online:v.online}));return{label:s.customName,online:s.online,isExpanded:!1,children:c}}),h.push(...l),await H(()=>{const s=parseInt(window.localStorage.getItem("JessibucaIndexLayout"))||4;n=w.slice(0,s).map(c=>k(c)),console.log("create videoPlayer ...",n)}),(parseInt(window.localStorage.getItem("JessibucaPollInterval"))||0)>0&&U()}),K(()=>{console.log("destroy videoPlayer ...",n),n.forEach(e=>e.destroy()),window.location.reload()});const k=e=>new Jessibuca({container:e,videoBuffer:.2,isResize:!1,text:"",loadingText:"加载中",decoder:"/jessibuca/decoder.js",hasAudio:!1,debug:!1,showBandwidth:!1,operateBtns:{fullscreen:!1,screenshot:!1,play:!1,audio:!1},vod:!0,forceNoOffscreen:!0,isNotMute:!1}),q=e=>{o.value===e?o.value=-1:o.value=e},B=async(e,a)=>{if(o.value===-1)return;const l=h[e].children[a];try{await n[o.value].destroy(),i[o.value].label=l.label+" 播放中...",i[o.value].isPlaying=!1,n[o.value]=k(w[o.value]);let t=l.key.split("_")[0],s=l.key.split("_")[1];const c=await L({deviceId:t,channelId:s});n[o.value].play(c.data.httpFlv.replace("http","ws")),i[o.value].label="",i[o.value].isPlaying=!0,o.value=-1}catch(t){console.error("播放失败",t),m(o.value),o.value=-1}},m=e=>{i[e].label=""},R=e=>{h[e].isExpanded=!h[e].isExpanded},E=b(null),M=e=>{e.stopPropagation(),e.target.classList.contains("video-container")||$()},$=()=>{if(document.fullscreenElement)document.exitFullscreen();else{const e=E.value,a=e.requestFullscreen||e.webkitRequestFullscreen||e.mozRequestFullScreen||e.msRequestFullscreen;a&&a.call(e).catch(l=>{console.error("全屏请求失败:",l)}),e.classList.add("fullscreen-active")}},z=e=>{p.value=e,n.forEach(a=>a.destroy()),n=[],window.localStorage.setItem("JessibucaIndexLayout",e.toString()),window.location.reload()},D=e=>{y.value=e,window.localStorage.setItem("JessibucaPollInterval",e.toString()),window.location.reload()},j=()=>{const e=[];return h.forEach(a=>{a.online===1&&a.children.forEach(l=>{l.online===1&&e.push({label:l.label,key:l.key})})}),e},A=async(e,a)=>new Promise(l=>{try{n[e]&&n[e].destroy(),i[e].label=a.label+" 播放中...",i[e].isPlaying=!1;let t=a.key.split("_")[0],s=a.key.split("_")[1];L({deviceId:t,channelId:s}).then(c=>{n[e]=k(w[e]),n[e].on("start",()=>{i[e].label="",i[e].isPlaying=!0,l(!0)}),n[e].on("error",v=>{console.error("播放失败",v),m(e),l(!1)}),setTimeout(()=>{i[e].isPlaying||(console.error("播放超时"),m(e),l(!1))},5e3),n[e].play(c.data.httpFlv.replace("http","ws"))}).catch(c=>{console.error("播放失败",c),m(e),l(!1)})}catch(t){console.error("播放失败",t),m(e),l(!1)}}),U=()=>{V.value&&clearInterval(V.value);const e=j();if(e.length===0)return;const a=async()=>{for(let t=0;t<9;t++)if(t<p.value){const s=e[S.value%e.length];await A(t,s)&&S.value++,await new Promise(v=>setTimeout(v,1e3))}},l=async()=>{await a(),y.value>0&&setTimeout(l,y.value*1e3)};l()};return(e,a)=>(d(),u("div",Z,[r("div",x,[r("div",ee,[P(r("select",{"onUpdate:modelValue":a[0]||(a[0]=l=>p.value=l),class:"layout-select",onChange:a[1]||(a[1]=l=>z(p.value))},[(d(),u(g,null,_(N,l=>r("option",{key:l.value,value:l.value},f(l.label),9,le)),64))],544),[[F,p.value]]),P(r("select",{"onUpdate:modelValue":a[2]||(a[2]=l=>y.value=l),class:"layout-select",onChange:a[3]||(a[3]=l=>D(y.value))},[(d(),u(g,null,_(T,l=>r("option",{key:l.value,value:l.value},f(l.label),9,ae)),64))],544),[[F,y.value]])]),r("div",te,[(d(!0),u(g,null,_(h,(l,t)=>(d(),u("div",{key:t,class:"menu-item"},[r("div",{class:C(["first-level",{offline:l.online!==1}]),onClick:s=>R(t)},[J(f(l.label)+" ",1),r("span",oe,f(l.isExpanded?"▼":"▶"),1)],10,se),P(r("div",ne,[(d(!0),u(g,null,_(l.children,(s,c)=>(d(),u("div",{key:c,class:C(["sub-item",{offline:s.online!==1}]),onClick:v=>B(t,c)},[r("span",re,f(c+1),1),J(" "+f(s.label),1)],10,ce))),128))],512),[[Q,l.isExpanded]])]))),128))])]),r("div",{class:"content",ref_key:"contentRef",ref:E,onDblclick:M},[r("div",{class:"video-grid","data-layout":p.value},[(d(!0),u(g,null,_(i,(l,t)=>(d(),u("div",{key:t,class:C(["video-container",{selected:o.value===t}]),ref_for:!0,ref:s=>w[t]=s,style:W({display:t<p.value?"block":"none"}),onClick:s=>q(t)},[r("div",de,[l.label?(d(),u("div",ve,f(l.label),1)):l.isPlaying?X("",!0):(d(),u("div",fe," 视频信号"+f(t+1),1))])],14,ue))),128))],8,ie)],544)]))}},ge=O(pe,[["__scopeId","data-v-c178eb0a"]]);export{ge as default};
