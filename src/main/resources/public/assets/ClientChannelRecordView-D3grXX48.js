import{q as E,c as K,e as G,f as J,s as Q}from"./jtt808-PzOwMx6L.js";import{d as W,r as l,j as X,C as Z,G as k,b as C,c as u,w as m,f as _,F as V,y as T,z as $,h as x,e as P,o as v,i as I,_ as ee}from"./index-BYlyECpH.js";import{h as S}from"./moment-C5S46NFB.js";import{F as ae}from"./FlvPlayerModal-CXw7H9j7.js";import"./request-xFzgdMuq.js";const te=["href"],le={style:{padding:"20px"}},ne={style:{display:"flex","flex-direction":"column",gap:"15px"}},oe=W({__name:"ClientChannelRecordView",setup(se){const U=[{title:"终端手机号",dataIndex:"clientId",key:"clientId",customRender:()=>r.value},{title:"通道序号",dataIndex:"channelNo",key:"channelNo"},{title:"开始时间",dataIndex:"startTime",key:"startTime"},{title:"结束时间",dataIndex:"endTime",key:"endTime"},{title:"大小",dataIndex:"fileSize",key:"fileSize"},{title:"下载进度",dataIndex:"progress",key:"progress"},{title:"操作",key:"action",fixed:"right",width:350}],N=l([]),n=l({current:1,pageSize:10,total:0}),w=l(!1),p=async(a,e)=>{try{w.value=!0;const t={pageNo:a-1,pageSize:e,clientId:r.value,channelNo:f.value},h=await E(t);N.value=h.data.recordList,n.value.total=h.data.recordList.length,n.value.current=a}catch(t){console.error("获取数据失败:",t)}finally{w.value=!1}},B=a=>{const{current:e,pageSize:t}=a;p(e,t)},z=Z(),r=l(""),f=l("");X(()=>{r.value=z.query.clientId,f.value=z.query.channelNo,p(n.value.current,n.value.pageSize)});const c=l(!1),b=l(!1);l(4);const y=l(""),g=l(!1),M=l(""),i=l([k().subtract(1,"hour").minute(0).second(0),k().subtract(0,"hour").minute(0).second(0)]),Y=(a,e)=>{c.value=!0,y.value=e,i.value[0]=k(a.startTime),i.value[1]=k(a.endTime),o=a};let o;const F=async()=>{b.value=!0;try{let a=S(i.value[0].valueOf()).format("YYYY-MM-DD HH:mm:ss"),e=S(i.value[1].valueOf()).format("YYYY-MM-DD HH:mm:ss");if(y.value==="Download"){const t=await G({clientId:r.value,channelNo:f.value,startTime:a,endTime:e,mediaType:o.mediaType,streamType:o.streamType,storageType:o.storageType,size:o.size});I.success(t.message),await p(n.value.current,n.value.pageSize)}if(y.value==="PlayBack"){const t=await J({clientId:r.value,channelNo:f.value,startTime:a,endTime:e,mediaType:o.mediaType,streamType:o.streamType,storageType:o.storageType,size:o.size});c.value=!1,M.value=t.data.httpFlv,D=t.data.mediaKey,g.value=!0}}catch(a){console.log(a)}finally{b.value=!1,c.value=!1}};let D;const H=async()=>{try{const a=await Q({mediaKey:D});I.success(a.message)}catch(a){console.log(a)}finally{g.value=!1}},L=`${window.location.protocol}//${window.location.host}/`.replace(/\/$/,""),q=l(L),O=async a=>{a.loading=!0;try{const e=await K({fileName:a.fileName});I.success(e.message),await p(n.value.current,n.value.pageSize)}catch(e){console.log(e)}finally{a.loading=!1}};return(a,e)=>{const t=_("a-button"),h=_("a-table"),j=_("a-range-picker"),A=_("a-modal");return v(),C(V,null,[u(h,{columns:U,"data-source":N.value,pagination:n.value,onChange:B,loading:w.value,scroll:{x:"max-content"}},{bodyCell:m(({column:d,record:s})=>[d.key==="action"?(v(),C(V,{key:0},[u(t,{onClick:R=>Y(s,"PlayBack"),style:{"margin-right":"8px"}},{default:m(()=>e[3]||(e[3]=[x("回放")])),_:2},1032,["onClick"]),s.progress==0?(v(),$(t,{key:0,onClick:R=>Y(s,"Download"),style:{"margin-right":"8px"}},{default:m(()=>e[4]||(e[4]=[x("下载")])),_:2},1032,["onClick"])):T("",!0),s.fileName?(v(),C("a",{key:1,href:`${q.value}/backend/jtt808/downloadRecordFile/${s.fileName}`,style:{"margin-right":"10px"}},"下载文件",8,te)):T("",!0),s.fileName?(v(),$(t,{key:2,danger:"",onClick:R=>O(s),style:{"margin-right":"10px"},loading:s.loading},{default:m(()=>e[5]||(e[5]=[x("删除")])),_:2},1032,["onClick","loading"])):T("",!0)],64)):T("",!0)]),_:1},8,["data-source","pagination","loading"]),u(A,{visible:c.value,title:y.value,onOk:F,onCancel:e[1]||(e[1]=()=>{c.value=!1}),confirmLoading:b.value,width:400},{default:m(()=>[P("div",le,[P("div",ne,[u(j,{value:i.value,"onUpdate:value":e[0]||(e[0]=d=>i.value=d),format:"YYYY-MM-DD HH:mm:ss","show-time":"",allowClear:!1},null,8,["value"])])])]),_:1},8,["visible","title","confirmLoading"]),u(ae,{visible:g.value,flvUrl:M.value,onCancel:H,"onUpdate:visible":e[2]||(e[2]=d=>g.value=d)},null,8,["visible","flvUrl"])],64)}}}),ve=ee(oe,[["__scopeId","data-v-b169fcca"]]);export{ve as default};
