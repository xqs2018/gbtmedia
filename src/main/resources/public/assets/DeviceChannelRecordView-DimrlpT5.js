import{k as ne,l as oe,m as se,s as j,n as ie,o as re}from"./gbt28181-C3wyvrue.js";import{_ as K,r as o,D as ce,l as de,z as x,w as r,e as C,E as ue,t as E,f as y,o as u,n as ve,d as me,j as pe,C as fe,G as R,b as I,c as p,F as U,y as h,h as k,p as J,i as b}from"./index-BYlyECpH.js";import{h as G}from"./moment-C5S46NFB.js";import"./request-xFzgdMuq.js";const ye={__name:"FlvJsPlayerModal",props:{flvUrl:{type:String,required:!0},visible:{type:Boolean,default:!1},hasAudio:{type:Boolean,default:!1}},emits:["cancel"],setup(S,{expose:M,emit:T}){const s=S,_=T,l=o(null),V=()=>{if(!l.value&&mpegts.isSupported()){var i=document.getElementById("myVideo");l.value=mpegts.createPlayer({type:"flv",url:s.flvUrl,hasAudio:s.hasAudio},{isLive:!0}),l.value.attachMediaElement(i),l.value.load(),l.value.play(),l.value.on(flvjs.Events.STATISTICS_INFO,function(d){var v=Date.now()/1e3-d.currentTime;v>2&&(console.warn("High latency detected:",v),l.value().currentTime=d.currentTime+v)})}};M({playbackSpeed:i=>{console.log("playbackSpeed:",i);var d=document.getElementById("myVideo");d.playbackRate=i}});const m=()=>{l.value&&(l.value.unload(),l.value.detachMediaElement(),l.value.destroy(),l.value=void 0)},f=()=>{_("cancel")};return ce(()=>s.visible,i=>{i?ve(()=>{V()}):m()}),de(()=>{m()}),(i,d)=>{const v=y("a-modal");return u(),x(v,{visible:S.visible,onCancel:f,footer:null,width:"780px"},{title:r(()=>[C("span",null," FLV-JS视频播放器 "+E(S.flvUrl),1)]),default:r(()=>[d[0]||(d[0]=C("video",{autoplay:"",controls:"",width:"100%",height:"500",id:"myVideo"},null,-1)),ue(i.$slots,"default",{},void 0,!0)]),_:3},8,["visible"])}}},ge=K(ye,[["__scopeId","data-v-9036beea"]]),he=["href"],ke={style:{padding:"20px"}},_e={style:{display:"flex","flex-direction":"column",gap:"15px"}},we={class:"outer-container",style:{"margin-top":"5px"}},Ie=me({__name:"DeviceChannelRecordView",setup(S){const M=[{title:"设备ID",dataIndex:"deviceId",key:"deviceId",customRender:()=>m.value},{title:"通道ID",dataIndex:"channelId",key:"channelId",customRender:()=>f.value},{title:"名称",dataIndex:"name",key:"name"},{title:"开始时间",dataIndex:"startTime",key:"startTime"},{title:"结束时间",dataIndex:"endTime",key:"endTime"},{title:"下载进度",dataIndex:"progress",key:"progress"},{title:"操作",key:"action",fixed:"right",width:350}],T=o([]),s=o({current:1,pageSize:10,total:0}),_=o(!1),l=async(a,e)=>{try{_.value=!0;const n={pageNo:a-1,pageSize:e,deviceId:m.value,channelId:f.value},P=await ne(n);T.value=P.data.recordList.map($=>({...$,loading:!1})),s.value.total=P.data.recordList.length,s.value.current=a}catch(n){console.error("获取数据失败:",n)}finally{_.value=!1}},V=a=>{const{current:e,pageSize:n}=a;l(e,n)},B=fe(),m=o(""),f=o("");pe(()=>{m.value=B.query.deviceId,f.value=B.query.channelId,l(s.value.current,s.value.pageSize)});const i=o(!1),d=o(!1),v=o(4),w=o(""),D=o(!1),F=o(""),g=o([R().subtract(1,"hour").minute(0).second(0),R().subtract(0,"hour").minute(0).second(0)]),L=(a,e)=>{i.value=!0,w.value=e,g.value[0]=R(a.startTime),g.value[1]=R(a.endTime)},Q=async()=>{d.value=!0;try{let a=G(g.value[0].valueOf()).format("YYYY-MM-DD HH:mm:ss"),e=G(g.value[1].valueOf()).format("YYYY-MM-DD HH:mm:ss");if(w.value==="Download"){const n=await ie({deviceId:m.value,channelId:f.value,startTime:a,endTime:e,downloadSpeed:v.value||4});b.success(n.message),await l(s.value.current,s.value.pageSize)}if(w.value==="PlayBack"){const n=await re({deviceId:m.value,channelId:f.value,startTime:a,endTime:e});i.value=!1,F.value=n.data.httpFlv,z=n.data.ssrc,A=n.data.callId,D.value=!0}}catch(a){console.log(a)}finally{d.value=!1,i.value=!1}};let z,A;const Y=o(1),H=o(),W=async a=>{try{const e=await oe({ssrc:z,speed:a});b.success(e.message),H.value.playbackSpeed(a)}catch(e){console.log(e)}},X=async()=>{try{Y.value=1;const a=await j({callId:A});b.success(a.message)}catch(a){console.log(a)}finally{D.value=!1}},Z=`${window.location.protocol}//${window.location.host}/`.replace(/\/$/,""),ee=o(Z),ae=async a=>{a.loading=!0;try{const e=await se({fileName:a.fileName});b.success(e.message),await l(s.value.current,s.value.pageSize)}catch(e){console.log(e)}finally{a.loading=!1}},le=async a=>{a.loading=!0;try{const e=await j({callId:a.callId});b.success(e.message),await l(s.value.current,s.value.pageSize)}catch(e){console.log(e)}finally{a.loading=!1}};return(a,e)=>{const n=y("a-button"),P=y("a-table"),$=y("a-range-picker"),O=y("a-select-option"),q=y("a-select"),te=y("a-modal");return u(),I(U,null,[p(P,{columns:M,"data-source":T.value,pagination:s.value,onChange:V,loading:_.value,scroll:{x:"max-content"}},{bodyCell:r(({column:t,record:c})=>[t.key==="action"?(u(),I(U,{key:0},[p(n,{onClick:N=>L(c,"PlayBack"),style:{"margin-right":"8px"}},{default:r(()=>e[5]||(e[5]=[k("回放")])),_:2},1032,["onClick"]),c.progress==0?(u(),x(n,{key:0,onClick:N=>L(c,"Download"),style:{"margin-right":"8px"}},{default:r(()=>e[6]||(e[6]=[k("下载")])),_:2},1032,["onClick"])):h("",!0),c.progress>0&&c.progress<99?(u(),x(n,{key:1,danger:"",loading:c.loading,onClick:N=>le(c),style:{"margin-right":"8px"}},{default:r(()=>e[7]||(e[7]=[k("停止下载")])),_:2},1032,["loading","onClick"])):h("",!0),c.fileName?(u(),I("a",{key:2,href:`${ee.value}/backend/gbt28181/downloadRecordFile/${c.fileName}`,style:{"margin-right":"10px"}},"下载文件",8,he)):h("",!0),c.fileName?(u(),x(n,{key:3,danger:"",onClick:N=>ae(c),style:{"margin-right":"10px"},loading:c.loading},{default:r(()=>e[8]||(e[8]=[k("删除")])),_:2},1032,["onClick","loading"])):h("",!0)],64)):h("",!0)]),_:1},8,["data-source","pagination","loading"]),p(te,{visible:i.value,title:w.value,onOk:Q,onCancel:e[2]||(e[2]=()=>{i.value=!1}),confirmLoading:d.value,width:400},{default:r(()=>[C("div",ke,[C("div",_e,[p($,{value:g.value,"onUpdate:value":e[0]||(e[0]=t=>g.value=t),format:"YYYY-MM-DD HH:mm:ss","show-time":"",allowClear:!1},null,8,["value"]),w.value=="Download"?(u(),x(q,{key:0,value:v.value,"onUpdate:value":e[1]||(e[1]=t=>v.value=t),placeholder:"选择倍速",style:{width:"100%"}},{default:r(()=>[(u(),I(U,null,J([1,4,8],t=>p(O,{key:t,value:t},{default:r(()=>[k(E(t)+" 倍速 ",1)]),_:2},1032,["value"])),64))]),_:1},8,["value"])):h("",!0)])])]),_:1},8,["visible","title","confirmLoading"]),p(ge,{visible:D.value,flvUrl:F.value,onCancel:X,ref_key:"flvPlayerRef",ref:H,"onUpdate:visible":e[4]||(e[4]=t=>D.value=t)},{default:r(()=>[C("div",we,[p(q,{value:Y.value,"onUpdate:value":e[3]||(e[3]=t=>Y.value=t),onChange:W,placeholder:"选择倍速",style:{width:"100%"}},{default:r(()=>[(u(),I(U,null,J([.25,.5,1,2,4],t=>p(O,{key:t,value:t},{default:r(()=>[k(E(t)+" 倍速 ",1)]),_:2},1032,["value"])),64))]),_:1},8,["value"])])]),_:1},8,["visible","flvUrl"])],64)}}}),De=K(Ie,[["__scopeId","data-v-8ccb5350"]]);export{De as default};
