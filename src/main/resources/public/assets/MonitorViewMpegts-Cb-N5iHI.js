import{_ as j,r as m,a as M,j as H,l as J,b as d,e as c,m as C,v as I,F as w,p as k,o as v,t as f,q as L,h as F,s as K,y as Q}from"./index-BYlyECpH.js";import{c as W,p as N}from"./gbt28181-C3wyvrue.js";import"./request-xFzgdMuq.js";const X={class:"container"},Y={class:"sidebar"},Z={class:"layout-switcher"},x=["value"],ee=["value"],le={class:"menu-scroll-container"},te=["onClick"],ae={class:"arrow"},se={class:"second-level"},ne=["onClick"],oe={class:"sequence-number"},ce=["data-layout"],re=["onClick"],ie={class:"video-box"},ue={key:0,class:"menu-label"},de={key:1,class:"video-signal"},ve={__name:"MonitorViewMpegts",setup(pe){const T=[{label:"1分屏",value:1},{label:"4分屏",value:4},{label:"6分屏",value:6},{label:"9分屏",value:9}],R=[{label:"关闭",value:0},{label:"1分钟",value:60},{label:"5分钟",value:300},{label:"10分钟",value:600},{label:"无限制",value:86400}],p=m(parseInt(window.localStorage.getItem("MpegtsIndexLayout"))||4),h=m(parseInt(window.localStorage.getItem("MpegtsPollInterval"))||0),S=m(0),P=m(null),g=M([]),r=M(Array.from({length:p.value},()=>({label:"",isPlaying:!1}))),y=M(Array.from({length:p.value},()=>null));let s=[];const n=m(-1);H(async()=>{let l=(await W({})).data;l=l.map(o=>{let i=o.children.map(u=>({label:u.customName,key:o.gbId+"_"+u.gbId,online:u.online}));return{label:o.customName,online:o.online,isExpanded:!1,children:i}}),g.push(...l),(parseInt(window.localStorage.getItem("MpegtsPollInterval"))||0)>0&&G()}),J(()=>{P.value&&clearInterval(P.value),console.log("destroy videoPlayer ...",s),s.forEach(e=>e.destroy()),window.location.reload()});const _=e=>{r[e].label=""},A=e=>{g[e].isExpanded=!g[e].isExpanded},V=m(null),D=e=>{e.stopPropagation(),e.target.classList.contains("video-container")||O()},O=()=>{if(document.fullscreenElement)document.exitFullscreen();else{const e=V.value,a=e.reMpegtsullscreen||e.webkitRequestFullscreen||e.mozRequestFullScreen||e.msRequestFullscreen;a&&a.call(e).catch(l=>{console.error("全屏请求失败:",l)}),e.classList.add("fullscreen-active")}},q=e=>{const a=r.length,l=e;if(l<a){for(let t=l;t<a;t++)s[t]&&(s[t].destroy(),s[t]=null);r.splice(l),y.splice(l)}else if(l>a)for(let t=a;t<l;t++)r.push({label:"",isPlaying:!1}),y.push(null);p.value=e,window.localStorage.setItem("MpegtsIndexLayout",e.toString()),window.location.reload()},$=e=>{h.value=e,window.localStorage.setItem("MpegtsPollInterval",e.toString()),window.location.reload()},B=()=>{const e=[];return g.forEach(a=>{a.online===1&&a.children.forEach(l=>{l.online===1&&e.push({label:l.label,key:l.key})})}),e},E=async(e,a)=>new Promise(l=>{try{s[e]&&(s[e].pause(),s[e].unload(),s[e].detachMediaElement(),s[e].destroy(),s[e]=null),r[e].label=a.label+" 播放中...",r[e].isPlaying=!1;let t=a.key.split("_")[0],o=a.key.split("_")[1];N({deviceId:t,channelId:o}).then(i=>{s[e]=mpegts.createPlayer({type:"flv",url:i.data.httpFlv.replace("http","ws"),hasAudio:!1},{isLive:!0,liveSync:!0,liveSyncPlaybackRate:2}),s[e].attachMediaElement(y[e]),s[e].load(),y[e].muted=!0;const u=y[e].play();u!==void 0&&u.then(()=>{r[e].label="",r[e].isPlaying=!0,l(!0)}).catch(b=>{console.error("播放失败:",b),_(e),l(!1)}),s[e].on(mpegts.Events.LOADING_COMPLETE,function(b){console.log("检测到播放结束，重新开始播放",e,b),E(e,a)}),setTimeout(()=>{r[e].isPlaying||(console.error("播放超时"),_(e),l(!1))},5e3)}).catch(i=>{console.error("播放失败",i),_(e),l(!1)})}catch(t){console.error("播放失败",t),_(e),l(!1)}}),G=()=>{P.value&&clearInterval(P.value);const e=B();if(e.length===0)return;const a=async()=>{for(let t=0;t<9;t++)if(t<p.value){const o=e[S.value%e.length];await E(t,o)&&S.value++,await new Promise(u=>setTimeout(u,1e3))}},l=async()=>{await a(),h.value>0&&setTimeout(l,h.value*1e3)};l()},U=e=>{n.value===e?n.value=-1:n.value=e},z=async(e,a)=>{if(n.value===-1)return;const l=g[e].children[a];try{s[n.value]&&(s[n.value].pause(),s[n.value].unload(),s[n.value].detachMediaElement(),s[n.value].destroy(),s[n.value]=null),r[n.value].label=l.label+" 播放中...",r[n.value].isPlaying=!1;let t=l.key.split("_")[0],o=l.key.split("_")[1];const i=await N({deviceId:t,channelId:o});s[n.value]=mpegts.createPlayer({type:"flv",url:i.data.httpFlv.replace("http","ws"),hasAudio:!1},{isLive:!0,liveSync:!0,liveSyncPlaybackRate:2}),s[n.value].attachMediaElement(y[n.value]),s[n.value].load(),s[n.value].play(),s[n.value].on(mpegts.Events.LOADING_COMPLETE,function(u){console.log("LOADING_COMPLETE",u);const b={label:l.label,key:l.key};E(n.value,b)}),r[n.value].label="",r[n.value].isPlaying=!0,n.value=-1}catch(t){console.error("播放失败",t),_(n.value),n.value=-1}};return(e,a)=>(v(),d("div",X,[c("div",Y,[c("div",Z,[C(c("select",{"onUpdate:modelValue":a[0]||(a[0]=l=>p.value=l),class:"layout-select",onChange:a[1]||(a[1]=l=>q(p.value))},[(v(),d(w,null,k(T,l=>c("option",{key:l.value,value:l.value},f(l.label),9,x)),64))],544),[[I,p.value]]),C(c("select",{"onUpdate:modelValue":a[2]||(a[2]=l=>h.value=l),class:"layout-select",onChange:a[3]||(a[3]=l=>$(h.value))},[(v(),d(w,null,k(R,l=>c("option",{key:l.value,value:l.value},f(l.label),9,ee)),64))],544),[[I,h.value]])]),c("div",le,[(v(!0),d(w,null,k(g,(l,t)=>(v(),d("div",{key:t,class:"menu-item"},[c("div",{class:L(["first-level",{offline:l.online!==1}]),onClick:o=>A(t)},[F(f(l.label)+" ",1),c("span",ae,f(l.isExpanded?"▼":"▶"),1)],10,te),C(c("div",se,[(v(!0),d(w,null,k(l.children,(o,i)=>(v(),d("div",{key:i,class:L(["sub-item",{offline:o.online!==1}]),onClick:u=>z(t,i)},[c("span",oe,f(i+1),1),F(" "+f(o.label),1)],10,ne))),128))],512),[[K,l.isExpanded]])]))),128))])]),c("div",{class:"content",ref_key:"contentRef",ref:V,onDblclick:D},[c("div",{class:"video-grid","data-layout":p.value},[(v(!0),d(w,null,k(r,(l,t)=>(v(),d("div",{key:t,class:L(["video-container",{selected:n.value===t}]),onClick:o=>U(t)},[c("div",ie,[c("video",{width:"100%",height:"100%",autoplay:"",muted:"",controls:"",ref_for:!0,ref:o=>y[t]=o},null,512),l.label?(v(),d("div",ue,f(l.label),1)):l.isPlaying?Q("",!0):(v(),d("div",de," 视频信号"+f(t+1),1))])],10,re))),128))],8,ce)],544)]))}},ge=j(ve,[["__scopeId","data-v-f3012b2d"]]);export{ge as default};
